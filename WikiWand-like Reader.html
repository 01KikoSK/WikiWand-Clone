<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0f14" media="(prefers-color-scheme: dark)">
  <title>WikiWand-like Reader</title>
  <style>
    :root {
      --bg: #ffffff;
      --surface: #f7f8fa;
      --muted: #eef0f3;
      --text: #101216;
      --text-dim: #5b6573;
      --accent: #2a66f8;
      --accent-2: #143aa0;
      --link: #1a56db;
      --border: #e1e4ea;
      --shadow: 0 1px 2px rgba(10, 16, 20, 0.04), 0 8px 24px rgba(10, 16, 20, 0.06);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 18px;
      --content-width: 920px;
      --sidebar-width: 320px;
      --header-h: 64px;
      --toc-active: #2a66f8;
      --code-bg: #f4f6f8;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f14;
        --surface: #11161d;
        --muted: #19202a;
        --text: #e7ebf2;
        --text-dim: #9aa6b2;
        --accent: #6ea8ff;
        --accent-2: #90baff;
        --link: #8ab4ff;
        --border: #1f2732;
        --shadow: none;
        --code-bg: #0f141b;
      }
      img { filter: brightness(0.98) saturate(1.02); }
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    hr { border: 0; border-top: 1px solid var(--border); margin: 24px 0; }
    code, pre, kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: var(--code-bg);
      border-radius: 6px;
    }
    code { padding: 0 6px; }
    pre { padding: 12px; overflow: auto; }
    kbd {
      border: 1px solid var(--border);
      padding: 2px 6px;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.12);
      font-size: 0.9em;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-rows: var(--header-h) 1fr;
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: saturate(1.2) blur(10px);
      background: color-mix(in oklab, var(--bg) 74%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: calc(var(--content-width) + var(--sidebar-width) + 64px);
      padding: 0 20px;
      margin: 0 auto;
      height: var(--header-h);
      display: grid;
      grid-template-columns: 180px 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: 0.2px;
    }
    .brand .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
    }
    .search {
      position: relative;
    }
    .search input {
      width: 100%; height: 40px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 10px;
      padding: 0 14px 0 38px;
      outline: none;
      transition: border 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .search input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
      background: var(--bg);
    }
    .search .icon {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      width: 18px; height: 18px; opacity: 0.6;
    }
    .search .suggestions {
      position: absolute; left: 0; right: 0; top: 44px;
      background: var(--bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 12px;
      padding: 8px 0;
      display: none;
      max-height: 360px; overflow: auto;
      z-index: 1001;
    }
    .search .suggestions.open { display: block; }
    .search .sug {
      padding: 8px 12px;
      display: grid; gap: 2px;
      cursor: pointer;
    }
    .search .sug:hover { background: var(--surface); }
    .search .sug .title { font-weight: 600; }
    .search .sug .desc { color: var(--text-dim); font-size: 12px; }

    .actions { display: flex; align-items: center; gap: 10px; }
    .btn {
      height: 36px; padding: 0 12px; border-radius: 9px;
      border: 1px solid var(--border);
      background: var(--surface); color: var(--text);
      display: inline-flex; align-items: center; gap: 8px;
      cursor: pointer; user-select: none;
    }
    .btn:hover { background: var(--muted); }
    .btn.primary {
      background: var(--accent); border-color: transparent; color: #fff;
    }
    .btn.primary:hover { background: var(--accent-2); }
    .btn .ico { width: 18px; height: 18px; }

    .main {
      display: grid;
      grid-template-columns: minmax(0, var(--content-width)) var(--sidebar-width);
      gap: 32px;
      max-width: calc(var(--content-width) + var(--sidebar-width) + 64px);
      padding: 24px 20px 64px;
      margin: 0 auto;
    }
    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 1fr;
      }
      aside { order: -1; }
    }

    /* Content area */
    article {
      min-width: 0;
    }
    .hero {
      display: grid; grid-template-columns: 1fr 280px; gap: 24px;
      align-items: start;
    }
    @media (max-width: 880px) {
      .hero { grid-template-columns: 1fr; }
    }
    .title {
      font-size: 44px; line-height: 1.16; margin: 8px 0;
      letter-spacing: -0.02em;
    }
    .subtitle { color: var(--text-dim); margin-top: 0; }
    .lead {
      font-size: 18px; color: var(--text);
      margin: 16px 0 0;
    }
    .lead p { margin: 0 0 12px; }
    .infobox, .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .infobox .infobox-body, .card .card-body { padding: 14px; }
    .infobox img { width: 100%; height: auto; display: block; }
    .infobox table { width: 100%; border-collapse: collapse; }
    .infobox td, .infobox th { padding: 6px 0; border-bottom: 1px solid var(--border); vertical-align: top; }
    .infobox tr:last-child td, .infobox tr:last-child th { border-bottom: 0; }
    .infobox .caption { color: var(--text-dim); font-size: 13px; margin-top: 6px; }

    .content {
      background: var(--bg);
      border-radius: var(--radius-lg);
    }
    .content img { max-width: 100%; height: auto; border-radius: 10px; }
    .content figure { margin: 0; }
    .content p { margin: 12px 0; }
    .content h2, .content h3, .content h4 {
      scroll-margin-top: calc(var(--header-h) + 12px);
    }
    .content h2 {
      margin-top: 36px; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border);
      font-size: 28px;
    }
    .content h3 { margin-top: 24px; font-size: 22px; color: var(--text); }
    .content h4 { margin-top: 18px; font-size: 18px; color: var(--text-dim); }
    .content blockquote {
      border-left: 4px solid var(--border);
      margin: 12px 0; padding: 8px 12px; color: var(--text-dim);
      background: var(--surface); border-radius: 8px;
    }
    .content .hatnote, .content .ambox, .content .infobox.vcard { display: none; } /* declutter */

    .meta {
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center; color: var(--text-dim); font-size: 13px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 4px 8px; border-radius: 999px;
      white-space: nowrap;
    }

    /* TOC sidebar */
    aside {
      position: sticky; top: calc(var(--header-h) + 16px);
      align-self: start;
      max-height: calc(100vh - var(--header-h) - 32px);
      overflow: auto;
    }
    .toc {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
    }
    .toc h3 { margin: 6px 8px 8px; font-size: 14px; color: var(--text-dim); letter-spacing: 0.02em; }
    .toc a {
      display: block; padding: 6px 8px; border-radius: 8px; color: var(--text);
      text-decoration: none; font-size: 14px;
    }
    .toc a:hover { background: var(--muted); }
    .toc .lvl-3 { padding-left: 20px; font-size: 13px; color: var(--text-dim); }
    .toc .active { color: var(--toc-active); background: color-mix(in oklab, var(--accent) 12%, transparent); }

    /* Footer/meta area */
    .foot {
      margin-top: 36px; color: var(--text-dim); font-size: 13px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
    }

    /* Loading and toast */
    .loading {
      display: none; gap: 10px; align-items: center; color: var(--text-dim);
    }
    .loading.show { display: inline-flex; }
    .spinner {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid var(--border); border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: var(--text); color: var(--bg);
      padding: 10px 14px; border-radius: 10px;
      box-shadow: var(--shadow); opacity: 0; pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
    }
    .toast.show { opacity: 0.98; transform: translateX(-50%) translateY(-4px); }

    /* Minimal icons (SVG via mask) */
    .ico {
      display: inline-block;
      width: 18px; height: 18px;
      background: currentColor;
      mask-size: cover; -webkit-mask-size: cover;
    }
    .ico-sun { mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill="%23000"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10-9h2V1h-2v3zm7.03 1.05l1.79-1.79-1.79-1.79-1.79 1.79 1.79 1.79zM20 11v2h3v-2h-3zM6.76 19.16l-1.8 1.79 1.8 1.79 1.79-1.79-1.79-1.79zM11 20h2v3h-2v-3zm7.03-1.05l1.79 1.79 1.79-1.79-1.79-1.79-1.79 1.79zM12 6a6 6 0 100 12 6 6 0 000-12z"/></g></svg>') center / contain no-repeat; }
    .ico-moon { mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M21.75 15.5A9.75 9.75 0 1111.5 2.25a8 8 0 0010.25 13.25z"/></svg>') center / contain no-repeat; }
    .ico-search { mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M10 2a8 8 0 015.292 13.708l4 4-1.414 1.414-4-4A8 8 0 1110 2zm0 2a6 6 0 100 12 6 6 0 000-12z"/></svg>') center / contain no-repeat; }
    .ico-ext { mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M14 3h7v7h-2V6.414l-8.293 8.293-1.414-1.414L17.586 5H14V3z"/><path fill="%23000" d="M5 5h7v2H7v10h10v-5h2v7H5z"/></svg>') center / contain no-repeat; }
    .ico-wiki { mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path fill="%23000" d="M2 4h18v2H2zM3 8h16v2H3zM4 12h14v2H4zM5 16h12v2H5z"/></svg>') center / contain no-repeat; }

    /* Utility */
    .hidden { display: none !important; }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>Wikiview</div>
        </div>

        <div class="search" role="search">
          <span class="icon ico ico-search" aria-hidden="true"></span>
          <input id="search" type="search" placeholder="Search Wikipedia… (press s to focus)" autocomplete="off" aria-label="Search Wikipedia" />
          <div id="suggestions" class="suggestions" role="listbox" aria-label="Search suggestions"></div>
        </div>

        <div class="actions">
          <button id="themeToggle" class="btn" aria-label="Toggle theme"><span class="ico ico-moon"></span><span>Theme</span></button>
          <a id="viewSource" class="btn" target="_blank" rel="noopener"><span class="ico ico-ext"></span><span>Open on Wikipedia</span></a>
        </div>
      </div>
    </header>

    <div class="main">
      <article>
        <div class="hero">
          <div>
            <div class="meta">
              <span class="badge"><span class="ico ico-wiki"></span><span id="project">English Wikipedia</span></span>
              <span class="badge" id="desc"></span>
              <span class="badge"><span id="lang"></span></span>
            </div>
            <h1 class="title" id="title">Loading…</h1>
            <p class="subtitle" id="subtitle"></p>
            <div class="lead" id="lead"></div>
          </div>
          <aside class="infobox" id="heroBox" aria-live="polite"></aside>
        </div>

        <div class="content" id="content"></div>

        <div class="foot">
          <span class="loading" id="loading"><span class="spinner"></span> <span>Loading article…</span></span>
          <span id="updated"></span>
          <span>•</span>
          <span>Keyboard: <kbd>S</kbd> search, <kbd>/</kbd> search, <kbd>Esc</kbd> close</span>
        </div>
      </article>

      <aside>
        <nav class="toc" aria-label="Table of contents">
          <h3>Contents</h3>
          <div id="toc"></div>
        </nav>
      </aside>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // Config
    const WIKI = 'https://en.wikipedia.org';
    const API = (params) => `${WIKI}/w/api.php?origin=*&${params}`;
    const REST_SUMMARY = (title) => `${WIKI}/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    const REST_TITLE_SEARCH = (q) => `${WIKI}/w/rest.php/v1/search/title?q=${encodeURIComponent(q)}&limit=8`;
    const OPEN_SEARCH = (q) => API(`action=opensearch&search=${encodeURIComponent(q)}&limit=8&namespace=0`);

    // Helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const on = (el, ev, fn, opts) => el.addEventListener(ev, fn, opts);
    const html = (strings, ...vals) => String.raw({raw: strings}, ...vals);
    const strip = (s='') => s.replace(/\s+/g, ' ').trim();
    const capitalize = (s='') => s.charAt(0).toUpperCase() + s.slice(1);

    const toast = (msg, t=2200) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), t);
    };

    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      const btn = $('#themeToggle');
      btn.innerHTML = '';
      const spanIco = document.createElement('span');
      spanIco.className = `ico ${mode === 'dark' ? 'ico-sun' : 'ico-moon'}`;
      const spanText = document.createElement('span');
      spanText.textContent = 'Theme';
      btn.append(spanIco, spanText);
      try { localStorage.setItem('wikiview-theme', mode); } catch {}
    };
    const initTheme = () => {
      const saved = (()=>{ try { return localStorage.getItem('wikiview-theme'); } catch { return null; }})();
      if (saved) return setTheme(saved);
      const dark = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(dark ? 'dark' : 'light');
    };

    // State
    let currentTitle = null;
    let observer = null;

    // Loading UI
    const setLoading = (on) => {
      $('#loading').classList.toggle('show', !!on);
    };

    // Build TOC from headings
    const buildTOC = () => {
      const toc = $('#toc');
      toc.innerHTML = '';
      const heads = $$('.content h2, .content h3');
      heads.forEach(h => {
        const id = h.id || h.textContent.trim().toLowerCase().replace(/[^\w]+/g, '-');
        h.id = id;
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.textContent = h.textContent;
        if (h.tagName === 'H3') a.classList.add('lvl-3');
        toc.appendChild(a);
      });

      // Scrollspy
      observer && observer.disconnect();
      const opts = { rootMargin: '-50% 0px -45% 0px', threshold: 0 };
      observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.id;
          const link = $(`.toc a[href="#${CSS.escape(id)}"]`);
          if (!link) return;
          if (entry.isIntersecting) {
            $$('.toc a').forEach(a => a.classList.remove('active'));
            link.classList.add('active');
          }
        });
      }, opts);
      heads.forEach(h => observer.observe(h));
    };

    // Sanitize and adapt Wikipedia HTML into our styles
    const adaptContent = (root) => {
      // Remove edit links, audio players clutter, navboxes
      $$('.mw-editsection, .navbox, .vertical-navbox, .sistersitebox, .metadata, .refbegin, .mbox-small', root)
        .forEach(el => el.remove());
      // Clean references style a bit
      $$('.reflist', root).forEach(el => el.style.columnWidth = '320px');

      // Images: lazy + rounded
      $$('img', root).forEach(img => {
        img.loading = 'lazy';
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        img.style.borderRadius = '10px';
      });

      // Links: open external in new tab; internal intercepted
      $$('a', root).forEach(a => {
        const href = a.getAttribute('href') || '';
        if (href.startsWith('#')) return;
        if (href.startsWith('/wiki/')) {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const title = decodeURIComponent(href.replace(/^\/wiki\//, '')).replace(/_/g, ' ');
            navigateTo(title);
          });
        } else if (/^https?:\/\//i.test(href)) {
          a.target = '_blank';
          a.rel = 'noopener';
        }
      });

      // Tables: make scrollable on small screens
      $$('table', root).forEach(t => {
        t.style.display = 'block';
        t.style.overflowX = 'auto';
        t.style.maxWidth = '100%';
      });
    };

    // Build hero infobox-like card from summary
    const buildHeroBox = (summary) => {
      const box = $('#heroBox');
      box.innerHTML = '';
      const parts = [];

      if (summary.thumbnail?.source) {
        const img = document.createElement('img');
        img.src = summary.thumbnail.source;
        img.alt = summary.titles?.display || summary.title || 'Lead image';
        img.loading = 'lazy'; img.decoding = 'async'; img.referrerPolicy = 'no-referrer';
        box.appendChild(img);
      }

      const body = document.createElement('div');
      body.className = 'infobox-body';
      // Type and extract
      if (summary.description) {
        const p = document.createElement('div');
        p.className = 'caption';
        p.textContent = capitalize(summary.description);
        body.appendChild(p);
      }
      if (summary.extract) {
        const p = document.createElement('div');
        p.style.fontSize = '14px';
        p.style.color = 'var(--text)';
        p.textContent = strip(summary.extract);
        body.appendChild(p);
      }
      // Buttons
      const controls = document.createElement('div');
      controls.style.display = 'flex';
      controls.style.gap = '8px';
      controls.style.marginTop = '8px';

      const openBtn = document.createElement('a');
      openBtn.className = 'btn primary';
      openBtn.href = `${WIKI}/wiki/${encodeURIComponent(summary.titles?.canonical || summary.title)}`;
      openBtn.target = '_blank'; openBtn.rel = 'noopener';
      openBtn.innerHTML = '<span class="ico ico-ext"></span><span>Open original</span>';

      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn';
      shareBtn.innerHTML = '<span class="ico ico-ext"></span><span>Copy link</span>';
      on(shareBtn, 'click', async () => {
        const url = location.href;
        try { await navigator.clipboard.writeText(url); toast('Link copied'); }
        catch { toast('Copy failed'); }
      });

      controls.append(openBtn, shareBtn);
      body.appendChild(controls);
      box.appendChild(body);
      box.classList.toggle('hidden', !summary.thumbnail?.source && !summary.extract);
    };

    const fetchJSON = async (url) => {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    };

    const setSourceLink = (title) => {
      const link = $('#viewSource');
      link.href = `${WIKI}/wiki/${encodeURIComponent(title.replace(/ /g, '_'))}`;
    };

    const renderSummary = (summary) => {
      $('#title').textContent = summary.titles?.display || summary.title || '';
      $('#subtitle').textContent = summary.description || '';
      $('#desc').textContent = summary.description ? capitalize(summary.description) : 'Article';
      $('#lang').textContent = summary.lang ? `Language: ${summary.lang}` : '';
      $('#lead').innerHTML = summary.extract_html || '';
      buildHeroBox(summary);
      setSourceLink(summary.titles?.canonical || summary.title || currentTitle);
      document.title = `${summary.titles?.display || summary.title} — Wikiview`;
    };

    const renderContentHTML = (htmlString) => {
      const container = document.createElement('div');
      container.innerHTML = htmlString;
      // Wikipedia parse returns a wrapper div with class="mw-parser-output"
      const mw = container.querySelector('.mw-parser-output') || container;
      const content = $('#content');
      content.innerHTML = '';
      // Move references to bottom
      adaptContent(mw);
      content.append(...mw.childNodes);
      buildTOC();
      // Smooth scrolling for TOC
      $$('#toc a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const id = a.getAttribute('href').slice(1);
          const target = document.getElementById(id);
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.replaceState({}, '', `#${encodeURIComponent(id)}`);
        });
      });
    };

    const loadArticle = async (title) => {
      currentTitle = title;
      setLoading(true);
      try {
        // Summary (lead + image)
        const summary = await fetchJSON(REST_SUMMARY(title));
        renderSummary(summary);

        // Full HTML via action=parse
        const parse = await fetchJSON(API(`action=parse&prop=text|sections&page=${encodeURIComponent(summary.titles?.canonical || title)}&format=json`));
        const html = parse?.parse?.text?.['*'] || '<p>Content unavailable.</p>';
        renderContentHTML(html);

        // Updated info
        const pageid = parse?.parse?.pageid;
        $('#updated').textContent = pageid ? `Page ID: ${pageid}` : '';
        history.replaceState({}, '', `?article=${encodeURIComponent(summary.titles?.canonical || title)}`);
      } catch (err) {
        console.error(err);
        toast('Could not load article. Try another query.');
        $('#title').textContent = 'Not found';
        $('#subtitle').textContent = '';
        $('#lead').textContent = '';
        $('#content').innerHTML = '<p>That article could not be loaded. Check your connection or try a different title.</p>';
      } finally {
        setLoading(false);
      }
    };

    // Internal navigation: intercept in-content wiki links
    const navigateTo = (title) => {
      loadArticle(title);
      // push state so back/forward works
      history.pushState({ article: title }, '', `?article=${encodeURIComponent(title)}`);
    };

    // Search suggestions
    let sugIndex = -1;
    const updateSuggestions = async (q) => {
      const box = $('#suggestions');
      if (!q) { box.classList.remove('open'); box.innerHTML = ''; return; }
      try {
        let data;
        try {
          // REST title search (fast, modern)
          const res = await fetchJSON(REST_TITLE_SEARCH(q));
          data = res?.pages?.map(p => ({ title: p.title, desc: p.description || '', article: p.key })) || [];
        } catch {
          // Fallback to opensearch
          const res = await fetchJSON(OPEN_SEARCH(q));
          data = (res?.[1] || []).map((t, i) => ({ title: t, desc: res?.[2]?.[i] || '', article: t }));
        }
        box.innerHTML = '';
        data.forEach((it, i) => {
          const div = document.createElement('div');
          div.className = 'sug';
          div.setAttribute('role', 'option');
          div.innerHTML = `<div class="title">${it.title}</div><div class="desc">${it.desc || ''}</div>`;
          on(div, 'click', () => {
            box.classList.remove('open');
            $('#search').value = it.title;
            navigateTo(it.article);
          });
          box.appendChild(div);
        });
        box.classList.toggle('open', data.length > 0);
        sugIndex = -1;
      } catch {
        box.classList.remove('open');
      }
    };

    // Events
    on(window, 'popstate', (e) => {
      const url = new URL(location.href);
      const t = url.searchParams.get('article') || 'Wikipedia';
      loadArticle(t);
    });

    on(document, 'keydown', (e) => {
      const box = $('#suggestions');
      const open = box.classList.contains('open');
      if ((e.key === 's' || e.key === '/') && !/input|textarea/i.test(document.activeElement.tagName)) {
        e.preventDefault();
        $('#search').focus();
        $('#search').select();
      } else if (e.key === 'Escape' && open) {
        box.classList.remove('open');
      } else if (open && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
        e.preventDefault();
        const items = $$('.sug', box);
        if (!items.length) return;
        if (e.key === 'ArrowDown') sugIndex = (sugIndex + 1) % items.length;
        else sugIndex = (sugIndex - 1 + items.length) % items.length;
        items.forEach((el, i) => el.style.background = i === sugIndex ? 'var(--muted)' : 'transparent');
      } else if (open && e.key === 'Enter') {
        const items = $$('.sug', box);
        if (sugIndex >= 0 && items[sugIndex]) {
          items[sugIndex].click();
        }
      }
    });

    on($('#themeToggle'), 'click', () => {
      const cur = document.documentElement.dataset.theme || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });

    on($('#search'), 'input', (e) => updateSuggestions(e.target.value.trim()));
    on($('#search'), 'focus', (e) => updateSuggestions(e.target.value.trim()));
    on($('#search'), 'blur', () => setTimeout(()=> $('#suggestions').classList.remove('open'), 120));
    on($('#search'), 'keydown', (e) => {
      if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (q) {
          $('#suggestions').classList.remove('open');
          navigateTo(q);
        }
      }
    });

    // Init
    (function init() {
      initTheme();
      const url = new URL(location.href);
      const t = url.searchParams.get('article');
      loadArticle(t || 'Alan Turing');
    })();
  </script>
</body>
</html>
```